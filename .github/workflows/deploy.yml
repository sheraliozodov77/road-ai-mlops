- name: 📦 Checkout code
  uses: actions/checkout@v3

- name: 🔑 Setup SSH
  uses: webfactory/ssh-agent@v0.9.0
  with:
    ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

- name: 📡 Add EC2 host to known_hosts
  run: |
    ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

- name: 🛠 Deploy to EC2
  run: |
    ssh ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
      cd ~/road-ai-mlops
      git pull origin master

      echo "🔁 (Optional) Register latest ONNX models to MLflow"
      python3 scripts/register_models.py || true

      echo "🐳 Rebuild and restart Docker container"
      docker compose -f docker-compose.prod.yml down
      docker compose -f docker-compose.prod.yml up --build -d
    EOF
